# -- GENERAL
ClusterName={{ .Release.Name }}
SwitchType=switch/none
MaxArraySize=4000001
MaxJobCount=40000000
LaunchParameters=use_interactive_step
DisableRootJobs=NO # change to YES
ReturnToService=2
RebootProgram=/usr/sbin/reboot
JobRequeue=0
EnforcePartLimits=ALL
# MpiDefault=none
# MailProg=/bin/mailx

# -- AUTHENTICATION
CredType=cred/munge
AuthType=auth/munge
AuthAltTypes=auth/jwt
AuthAltParameters=jwt_key=/etc/jwt/jwt_hs256.key

# -- SLURMCTLD
SlurmctldHost={{ include "slurm.hosts.slurmctld" . }}
SlurmctldParameters=enable_configless
SlurmctldPort=6817
SlurmUser=root # change to slurm after fixing docker image 
SlurmctldPidFile=/var/run/slurm/slurmctld.pid
StateSaveLocation=/var/spool/slurm/slurmctld
SlurmctldDebug=info
SlurmctldLogFile=/dev/null
SlurmSchedLogLevel=1
SlurmSchedLogFile=/dev/null
SlurmctldTimeout=30

# -- SLURMD
SlurmdUser=root
SlurmdPort=6818
SlurmdPidFile=/var/run/slurm/slurmd.pid
SlurmdSpoolDir=/var/spool/slurm/slurmd
SlurmdDebug=info
SlurmdLogFile=/dev/null
SlurmdTimeout={{ .Values.slurm_config.slurmd_timeout }}

# -- TASKS
ProctrackType={{ include "slurm.formatPluginList" .Values.slurm_config.plugins.ProctrackType }}
TaskPlugin={{ include "slurm.formatPluginList" .Values.slurm_config.plugins.TaskPlugin }}
JobContainerType=job_container/none
CpuFreqDef=Performance
SelectType=select/cons_tres
SelectTypeParameters=CR_CPU_Memory
GresTypes=cards,gpu,shard
LogTimeFormat=rfc5424

# -- POWER
# PowerPlugin=power/none
# PowerParameters=balance_interval=30,cap_watts=10KW,decrease_rate=30,increase_rate=10,lower_threshold=85,upper_threashold=98
Licenses=watts:2386200
JobSubmitPlugins=lua

# -- TIMERS 
InactiveLimit=0
KillWait=30
WaitTime=0
MinJobAge=10
UnkillableStepTimeout=1800


# -- SCHEDULING --
PriorityType=priority/multifactor
PriorityFlags=MAX_TRES
PriorityWeightFairshare=100000
PriorityWeightTRES=CPU=2000,Mem=2000,GRES/gpu=10000,GRES/cards=10000
PriorityWeightPartition=100
PriorityWeightAge=1
PriorityDecayHalfLife=180

SchedulerType=sched/backfill
SchedulerParameters=batch_sched_delay=5,bf_busy_nodes,bf_continue,bf_interval=30,bf_job_part_count_reserve=200,bf_max_job_array_resv=5,bf_max_job_part=40000,bf_max_job_test=50000,bf_resolution=600,bf_window=770,bf_max_time=30,build_queue_timeout=10000000,default_queue_depth=1000,max_rpc_cnt=150,no_env_cache,sched_interval=30,sched_min_interval=5000000,bf_min_age_reserve=3600,bf_yield_interval=1000000,partition_job_depth=500
# FAST NEW

# STABLE NEW: SchedulerParameters=batch_sched_delay=20,bf_busy_nodes,bf_continue,bf_interval=60,bf_job_part_count_reserve=200,bf_max_job_array_resv=5,bf_max_job_part=40000,bf_max_job_test=50000,bf_resolution=600,bf_window=770,bf_max_time=30,build_queue_timeout=10000000,default_queue_depth=1000,defer,max_rpc_cnt=150,no_env_cache,sched_interval=30,sched_min_interval=2000000,bf_min_age_reserve=3600,bf_yield_interval=1000000,partition_job_depth=500


#STABLE OLD: SchedulerParameters=batch_sched_delay=20,bf_busy_nodes,bf_continue,bf_interval=120,bf_job_part_count_reserve=200,bf_max_job_array_resv=5,bf_max_job_part=40000,bf_max_job_test=50000,bf_resolution=600,bf_window=770,bf_max_time=30,build_queue_timeout=10000000,default_queue_depth=1000,defer,max_rpc_cnt=40,max_sched_time=5,no_env_cache,sched_interval=60

#FAST OLD: SchedulerParameters=batch_sched_delay=1,build_queue_timeout=5000000,default_queue_depth=3000,max_rpc_cnt=150,max_sched_time=5,no_env_cache,sched_interval=10,partition_job_depth=5000,sched_min_interval=10000


# -- ACCOUNTING
AccountingStorageType=accounting_storage/slurmdbd
AccountingStorageHost={{ include "slurm.hosts.slurmdbd" . }}
AccountingStoragePort=6819
AccountingStorageEnforce=limits,qos
AccountingStorageTRES=gres/cards,gres/gpu,gres/shard
AccountingStoreFlags=job_comment
JobAcctGatherType={{ include "slurm.formatPluginList" .Values.slurm_config.plugins.JobAcctGatherType }}
JobAcctGatherFrequency=30
AcctGatherProfileType=acct_gather_profile/influxdb
# AcctGatherEnergyType=acct_gather_energy/ipmi
# AcctGatherNodeFreq=30
JobCompType=jobcomp/kafka
JobCompLoc=/etc/slurm/rdkafka.conf
JobCompParams=flush_timeout=500,poll_interval=2,requeue_on_msg_timeout,topic={{ .Release.Name }}


# -- COMPUTE NODES -- 
include /etc/slurm/nodes.conf


# -- PARTITIONS -- 
include /etc/slurm/partitions.conf
